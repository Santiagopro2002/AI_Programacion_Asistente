
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Asistente IA - Mejorado</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="shortcut icon" href="logo_ia-dark.ico" type="image/x-icon">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #0f172a;
      color: #f1f5f9;
    }

    .sidebar {
      background-color: #1e293b;
      width: 250px;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      overflow-y: auto;
      transition: all 0.3s;
      z-index: 1000;
    }

    .sidebar.collapsed {
      width: 70px;
    }

    .sidebar .user-profile {
      text-align: center;
      padding: 20px 0;
    }

    .sidebar .user-img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
    }

    .sidebar .username {
      font-weight: bold;
      margin-top: 10px;
    }

    .sidebar .nav-link {
      color: #cbd5e1;
      padding: 12px 20px;
      display: flex;
      align-items: center;
    }

    .sidebar .nav-link:hover {
      background-color: #334155;
      color: #fff;
    }

    .sidebar.collapsed .nav-link span,
    .sidebar.collapsed .username,
    .sidebar.collapsed .user-img {
      display: none;
    }

    .main-content {
      margin-left: 250px;
      transition: all 0.3s;
      padding: 20px;
    }

    .main-content.expanded {
      margin-left: 70px;
    }

    .menu-toggle {
      background: none;
      border: none;
      color: #f1f5f9;
      font-size: 1.5rem;
    }

    .chat-container {
      height: calc(100vh - 140px);
      overflow-y: auto;
      background: #1e293b;
      border-radius: 10px;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .message {
      max-width: 80%;
      padding: 12px 16px;
      margin-bottom: 10px;
      border-radius: 20px;
      word-wrap: break-word;
    }

    .user-message {
      background-color: #0f172a;
      color: white;
      align-self: flex-end;
    }

    .ia-message {
      background-color: #06b6d4;
      color: white;
      align-self: flex-start;
    }

    .input-area {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    @media (max-width: 768px) {
      .sidebar {
        position: absolute;
        height: 100%;
        z-index: 1000;
      }

      .main-content {
        margin-left: 0;
      }

      .main-content.expanded {
        margin-left: 0;
      }
    }

    .message-icon {
      margin-right: 8px;
    }

    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      margin: 0;
    }
  </style>
</head>
<body>

<div class="sidebar" id="sidebar">
  <div class="user-profile">
    <img src="logo_ia-dark.png" alt="Usuario" class="user-img">
    <div class="username" id="nombreUsuario">Usuario</div>
  </div>
  <ul class="nav flex-column px-2">
    <li class="nav-item mb-2">
      <a href="#" onclick="nuevaSesion()" class="nav-link">
        <i class="bi bi-plus-circle me-2"></i> <span>Nueva Sesi√≥n</span>
      </a>
    </li>
    <li class="nav-item dropdown mb-2">
      <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
        <i class="bi bi-gear me-2"></i> <span>Configuraci√≥n</span>
      </a>
      <ul class="dropdown-menu bg-dark border-0">
        <li><a class="dropdown-item text-white" href="editarcredenciales.html"><i class="bi bi-pencil-square me-2"></i> Editar Credenciales</a></li>
        <li><a class="dropdown-item text-white" href="#" onclick="exportarHistorial()"><i class="bi bi-file-earmark-text me-2"></i> Exportar Chat</a></li>
      </ul>
    </li>
  </ul>
  <hr class="text-white mx-3">
  <div id="listaHistorial" class="px-3" style="max-height: 350px; overflow-y: auto;">
    <!-- Historial din√°mico -->
  </div>
  <ul class="nav flex-column px-2 mt-auto mb-3">
    <li>
      <a href="#" onclick="cerrarSesion()" class="nav-link text-danger">
        <i class="bi bi-box-arrow-right me-2"></i> <span>Cerrar Sesi√≥n</span>
      </a>
    </li>
  </ul>
</div>

<div class="main-content" id="mainContent">
  <button class="menu-toggle mb-3" onclick="toggleSidebar()"><i class="bi bi-list"></i></button>

  <div class="chat-container" id="chatContainer">
    <!-- Mensajes aparecer√°n aqu√≠ -->
  </div>

  <div class="input-area">
    <input type="text" class="form-control" id="pregunta" placeholder="Escribe tu pregunta...">
    <button class="btn btn-success" onclick="enviarPregunta()">Enviar</button>
  </div>
</div>

<script>
function toggleSidebar() {
  document.getElementById("sidebar").classList.toggle("collapsed");
  document.getElementById("mainContent").classList.toggle("expanded");
}

document.getElementById('nombreUsuario').textContent = localStorage.getItem('nombre_usuario') || 'Usuario';

let id_usuario = localStorage.getItem('id_usuario');
let id_sesion = localStorage.getItem('id_sesion');

window.addEventListener('DOMContentLoaded', () => {
  mostrarHistorial();
  cargarHistorial();
});

async function nuevaSesion() {
  const res = await fetch('http://34.228.220.157:5000/crear_sesion', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id_usuario, nombre_sesion: 'Sesi√≥n ' + new Date().toLocaleString() })
  });
  const datos = await res.json();
  if (res.ok) {
    id_sesion = datos.id_sesion;
    localStorage.setItem('id_sesion', id_sesion);
    document.getElementById('chatContainer').innerHTML = '';
    mostrarHistorial();
    Swal.fire("¬°Sesi√≥n creada con √©xito!", "", "success");
  }
}

async function mostrarHistorial() {
  const res = await fetch(`http://34.228.220.157:5000/listar_sesiones/${id_usuario}`);
  const sesiones = await res.json();
  const lista = document.getElementById('listaHistorial');
  lista.innerHTML = '<h6 class="text-white">Sesiones anteriores:</h6>';
  sesiones.forEach(sesion => {
    const btn = document.createElement('button');
    btn.textContent = sesion.nombre_sesion;
    btn.className = 'btn btn-sm btn-outline-light mb-1 w-100 text-start';
    btn.onclick = () => cargarSesion(sesion.id);
    lista.appendChild(btn);
  });
}

async function cargarSesion(id) {
  id_sesion = id;
  localStorage.setItem('id_sesion', id_sesion);
  const res = await fetch(`http://34.228.220.157:5000/historial/${id_usuario}/${id_sesion}`);
  const historial = await res.json();
  const container = document.getElementById('chatContainer');
  container.innerHTML = '';
  historial.forEach(m => {
    agregarMensaje(m.pregunta, 'user');
    agregarMensaje(m.respuesta, 'ia');
  });
}

function agregarMensaje(texto, tipo, temporal = false) {
  const contenedor = document.getElementById('chatContainer');
  const div = document.createElement('div');
  div.className = `message ${tipo}-message`;
  const icon = document.createElement('span');
  icon.className = 'message-icon';
  icon.textContent = tipo === 'user' ? 'ü•∑üèΩ' : 'ü§ñ';
  const content = document.createElement('pre');
  content.textContent = texto;
  div.appendChild(icon);
  div.appendChild(content);
  contenedor.appendChild(div);
  contenedor.scrollTop = contenedor.scrollHeight;
  return temporal ? div : null;
}

async function enviarPregunta() {
  const pregunta = document.getElementById('pregunta').value.trim();
  if (!pregunta || !id_usuario || !id_sesion) return;
  agregarMensaje(pregunta, 'user');
  const writing = agregarMensaje('La IA est√° escribiendo...', 'ia', true);
  try {
    const res = await fetch('http://34.228.220.157:5000/preguntas', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id_usuario, pregunta, id_sesion })
    });
    const datos = await res.json();
    writing.remove();
    agregarMensaje(datos.respuesta || '‚ùå Error consultando la IA.', 'ia');
  } catch {
    writing.remove();
    agregarMensaje('‚ùå Error de conexi√≥n.', 'ia');
  }
  document.getElementById('pregunta').value = '';
}

function exportarHistorial() {
  window.open(`http://34.228.220.157:5000/exportar/${id_usuario}`, '_blank');
}

function cerrarSesion() {
  localStorage.clear();
  window.location.href = 'index.html';
}
</script>

</body>
</html>