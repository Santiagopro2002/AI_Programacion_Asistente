<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Asistente IA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #EAEAEA;
      color: #1A1A1A;
    }

    .sidebar {
      background-color: #1A1A1A;
      color: #EAEAEA;
      position: fixed;
      top: 0;
      bottom: 0;
      left: -250px;
      width: 250px;
      z-index: 2000;
      overflow-y: auto;
      transition: left 0.3s;
      padding: 1rem;
    }

    .sidebar.show {
      left: 0;
    }

    .sidebar .nav-link {
      color: #EAEAEA;
      margin: 10px 0;
    }

    .sidebar .nav-link:hover {
      background-color: #333;
      border-radius: 5px;
      padding-left: 10px;
    }

    .topbar {
      background-color: #1A1A1A;
      color: #EAEAEA;
      padding: 10px 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .chat-container {
      margin-left: 0;
      padding: 20px;
      height: calc(100vh - 60px);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .message {
      padding: 12px 18px;
      border-radius: 20px;
      margin-bottom: 12px;
      max-width: 70%;
      word-wrap: break-word;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .user-message {
      background-color: #0B3D3C;
      color: white;
      align-self: flex-end;
      justify-content: flex-end;
      text-align: right;
    }

    .ia-message {
      background-color: #4d694b;
      color: white;
      align-self: flex-start;
    }

    .input-area {
      background-color: #EAEAEA;
      padding: 10px;
      display: flex;
      gap: 10px;
      border-top: 1px solid #ccc;
    }

    .btn-enviar {
      background-color: #0B3D3C;
      color: white;
      border: none;
    }

    .btn-enviar:hover {
      background-color: #093332;
    }

    .message-icon {
      font-size: 1.5rem;
    }

    @media (min-width: 768px) {
      .chat-container {
        margin-left: 250px;
      }
    }

    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      margin: 0;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <button class="btn btn-sm btn-light d-md-none" onclick="toggleSidebar()">
      <i class="bi bi-list"></i>
    </button>
    <span class="fw-bold">Asistente IA</span>
  </div>

  <div class="sidebar" id="sidebar">
    <h5>Men√∫</h5>
    <hr style="border-color: #555;">
    <a href="#" class="nav-link" onclick="alert('Nueva sesi√≥n')"><i class="bi bi-plus-circle me-2"></i> Nueva Sesi√≥n</a>
    <a href="#" class="nav-link" onclick="alert('Editar credenciales')"><i class="bi bi-pencil me-2"></i> Editar Credenciales</a>
    <a href="#" class="nav-link" onclick="alert('Exportar historial')"><i class="bi bi-download me-2"></i> Exportar Historial</a>
    <a href="#" class="nav-link text-danger" onclick="alert('Cerrar sesi√≥n')"><i class="bi bi-box-arrow-right me-2"></i> Cerrar Sesi√≥n</a>
  </div>

  <div class="chat-container" id="chatContainer">
    <div class="message user-message">
      <span class="message-icon">üßë</span>
      <pre>dame la suma de 10 n√∫meros</pre>
    </div>
    <div class="message ia-message">
      <span class="message-icon">ü§ñ</span>
      <pre>Para poder calcular la suma de 10 n√∫meros, necesito que me proporciones esos 10 n√∫meros espec√≠ficos...</pre>
    </div>
  </div>

  <div class="input-area">
    <input type="text" class="form-control" placeholder="Escribe tu pregunta..." />
    <button class="btn btn-enviar">Enviar</button>
  </div>

  <script>
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('show');
    }
  </script>
  <script>
    function toggleSidebar() {
      document.getElementById("sidebar").classList.toggle("collapsed");
      document.getElementById("mainContent").classList.toggle("expanded");
    }
    
    document.getElementById('nombreUsuario').textContent = localStorage.getItem('nombre_usuario') || 'Usuario';
    
    let id_usuario = localStorage.getItem('id_usuario');
    let id_sesion = localStorage.getItem('id_sesion');
    
    window.addEventListener('DOMContentLoaded', () => {
      mostrarHistorial();
      cargarHistorial();
    });
    
    async function nuevaSesion() {
      const res = await fetch('http://34.228.220.157:5000/crear_sesion', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id_usuario, nombre_sesion: 'Sesi√≥n ' + new Date().toLocaleString() })
      });
      const datos = await res.json();
      if (res.ok) {
        id_sesion = datos.id_sesion;
        localStorage.setItem('id_sesion', id_sesion);
        document.getElementById('chatContainer').innerHTML = '';
        mostrarHistorial();
        Swal.fire("¬°Sesi√≥n creada con √©xito!", "", "success");
      }
    }
    
    async function mostrarHistorial() {
      const res = await fetch(`http://34.228.220.157:5000/listar_sesiones/${id_usuario}`);
      const sesiones = await res.json();
      const lista = document.getElementById('listaHistorial');
      lista.innerHTML = '<h6 class="text-white">Sesiones anteriores:</h6>';
      sesiones.forEach(sesion => {
        const btn = document.createElement('button');
        btn.textContent = sesion.nombre_sesion;
        btn.className = 'btn btn-sm btn-outline-light mb-1 w-100 text-start';
        btn.onclick = () => cargarSesion(sesion.id);
        lista.appendChild(btn);
      });
    }
    
    async function cargarSesion(id) {
      id_sesion = id;
      localStorage.setItem('id_sesion', id_sesion);
      const res = await fetch(`http://34.228.220.157:5000/historial/${id_usuario}/${id_sesion}`);
      const historial = await res.json();
      const container = document.getElementById('chatContainer');
      container.innerHTML = '';
      historial.forEach(m => {
        agregarMensaje(m.pregunta, 'user');
        agregarMensaje(m.respuesta, 'ia');
      });
    }
    
    function agregarMensaje(texto, tipo, temporal = false) {
      const contenedor = document.getElementById('chatContainer');
      const div = document.createElement('div');
      div.className = `message ${tipo}-message`;
      const icon = document.createElement('span');
      icon.className = 'message-icon';
      icon.textContent = tipo === 'user' ? 'ü•∑üèΩ' : 'ü§ñ';
      const content = document.createElement('pre');
      content.textContent = texto;
      div.appendChild(icon);
      div.appendChild(content);
      contenedor.appendChild(div);
      contenedor.scrollTop = contenedor.scrollHeight;
      return temporal ? div : null;
    }
    
    async function enviarPregunta() {
      const pregunta = document.getElementById('pregunta').value.trim();
      if (!pregunta || !id_usuario || !id_sesion) return;
      agregarMensaje(pregunta, 'user');
      const writing = agregarMensaje('La IA est√° escribiendo...', 'ia', true);
      try {
        const res = await fetch('http://34.228.220.157:5000/preguntas', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id_usuario, pregunta, id_sesion })
        });
        const datos = await res.json();
        writing.remove();
        agregarMensaje(datos.respuesta || '‚ùå Error consultando la IA.', 'ia');
      } catch {
        writing.remove();
        agregarMensaje('‚ùå Error de conexi√≥n.', 'ia');
      }
      document.getElementById('pregunta').value = '';
    }
    
    function exportarHistorial() {
      window.open(`http://34.228.220.157:5000/exportar/${id_usuario}`, '_blank');
    }
    
    function cerrarSesion() {
      localStorage.clear();
      window.location.href = 'index.html';
    }
    </script>
</body>
</html>