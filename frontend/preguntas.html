<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente IA - Preguntas</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="shortcut icon" href="logo_ia-dark.ico" type="image/x-icon">


    <style>
        .sidebar {
    background-color: #133840;
    color: white;
    height: 100vh;
    overflow-y: auto;
}

.message {
    padding: 12px 18px;
    border-radius: 20px;
    margin-bottom: 12px;
    max-width: 80%;
    word-wrap: break-word;
    overflow-wrap: break-word;
    word-break: break-word;
    display: flex;
    align-items: flex-start;
    gap: 10px;
}

.user-message {
    background-color: #133840;
    color: white;
    align-self: flex-end;
    justify-content: flex-end;
    text-align: right;
}

.ia-message {
    background-color: #04BFAD;
    color: white;
    align-self: flex-start;
}

pre {
    margin: 0;
    white-space: pre-wrap;
}

@media (max-width: 768px) {
    .sidebar span {
        display: none;
    }

    .message {
        max-width: 95%;
        font-size: 0.9rem;
        padding: 10px 14px;
    }

    .input-area {
        flex-direction: column;
        gap: 10px;
    }

    .chat-container {
        padding: 10px;
    }
}

    </style>
</head>
<body class="overflow-hidden">

    <div class="container-fluid h-100">
        <div class="row h-100">
    
            <!-- Sidebar -->
            <div class="col-md-3 col-4 p-0 bg-dark text-white d-flex flex-column justify-content-between sidebar">
                <div class="p-3">
                    <img src="logo_ia-dark.png" alt="img" class="img-fluid mb-3 mx-auto d-block" style="max-height: 60px;">
                    <h5 id="Bienvenido" class="d-none d-md-block">Bienvenido:</h5>
                    <p id="nombreUsuario" class="text-center fw-bold d-none d-md-block">Usuario</p>
    
                    <ul class="nav flex-column">
                        <!-- enlaces -->
                    </ul>
    
                    <hr>
                    <div id="listaHistorial" class="overflow-auto" style="max-height: 350px;">
                        <!-- historial din√°mico -->
                    </div>
                </div>
                <ul class="nav flex-column p-3">
                    <li>
                        <a href="#" onclick="cerrarSesion()" class="nav-link text-danger d-flex align-items-center">
                            <i class="bi bi-box-arrow-right me-2"></i> <span class="d-none d-md-inline">Cerrar Sesi√≥n</span>
                        </a>
                    </li>
                </ul>
            </div>
    
            <!-- Chat Area -->
            <div class="col-md-9 col-8 d-flex flex-column chat-area p-0">
    
                <div class="chat-container flex-grow-1 overflow-auto p-3" id="chatContainer">
                    <!-- mensajes aqu√≠ -->
                </div>
    
                <div class="input-area d-flex p-3 border-top bg-white">
                    <input type="text" class="form-control me-2" id="pregunta" placeholder="Escribe tu pregunta...">
                    <button class="btn btn-success" onclick="enviarPregunta()">Enviar</button>
                </div>
    
            </div>
        </div>
    </div>
    


<script>
    async function nuevaSesion() {
    const id_usuario = localStorage.getItem('id_usuario');

    try {
        const res = await fetch('http://34.228.220.157:5000/crear_sesion', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id_usuario, nombre_sesion: 'Sesi√≥n ' + new Date().toLocaleString() })
        });
        const datos = await res.json();

        if (res.ok) {
            const id_sesion = datos.id_sesion;
            localStorage.setItem('id_sesion', id_sesion);

            // Limpia el chat
            const contenedor = document.getElementById('chatContainer');
            contenedor.innerHTML = '';

            // Vuelve a cargar el listado de sesiones
            mostrarHistorial();
            Swal.fire({
            title: "seci√≥n creada con exito!",
            icon: "success",
            draggable: true
            });
        }
    } catch (error) {
        console.error('Error creando sesi√≥n:', error);
        Swal.fire({
            icon: "error",
            title: "Oops...",
            text: "no se puedo cargra nueva seci√≥n!",
            footer: '<a href="#">Why do I have this issue?</a>'
            });
    }
}

// Mostrar nombre del usuario
document.getElementById('nombreUsuario').textContent = localStorage.getItem('nombre_usuario') || 'Usuario';

let id_usuario = localStorage.getItem('id_usuario');
let id_sesion = localStorage.getItem('id_sesion');

// Mostrar sesiones al cargar la p√°gina
window.addEventListener('DOMContentLoaded', () => {
    mostrarHistorial();  // solo carga el historial de sesiones
    cargarHistorial();   // carga el historial de la sesi√≥n activa si existe
});

async function crearSesion() {
    try {
        const res = await fetch('http://34.228.220.157:5000/crear_sesion', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id_usuario, nombre_sesion: 'Sesi√≥n ' + new Date().toLocaleString() })
        });
        const datos = await res.json();
        if (res.ok) {
            id_sesion = datos.id_sesion;
            localStorage.setItem('id_sesion', id_sesion);
        }
    } catch (error) {
        console.error('Error creando sesi√≥n:', error);
    }
}



// Mostrar lista de sesiones del usuario
async function mostrarHistorial() {
    try {
        const res = await fetch(`http://34.228.220.157:5000/listar_sesiones/${id_usuario}`);
        const sesiones = await res.json();

        const lista = document.getElementById('listaHistorial');
        lista.innerHTML = '<h6 class="text-white">Sesiones anteriores:</h6>';

        sesiones.forEach(sesion => {
            const boton = document.createElement('button');
            boton.textContent = sesion.nombre_sesion;
            boton.className = 'btn btn-sm btn-outline-light mb-1 w-100 text-start';
            boton.onclick = () => cargarSesion(sesion.id);
            lista.appendChild(boton);
        });
    } catch (e) {
        alert('Error cargando el historial');
    }
}

// Cargar el historial de una sesi√≥n
async function cargarSesion(id) {
    id_sesion = id;
    localStorage.setItem('id_sesion', id_sesion);

    try {
        const res = await fetch(`http://34.228.220.157:5000/historial/${id_usuario}/${id_sesion}`);
        const historial = await res.json();

        const contenedor = document.getElementById('chatContainer');
        contenedor.innerHTML = '';

        historial.forEach(m => {
            agregarMensaje(m.pregunta, 'user');
            agregarMensaje(m.respuesta, 'ia');
        });
    } catch (e) {
        alert('Error cargando la sesi√≥n');
    }
}

// Enviar pregunta
async function enviarPregunta() {
    const pregunta = document.getElementById('pregunta').value.trim();
    if (!pregunta || !id_usuario || !id_sesion) return;

    agregarMensaje(pregunta, 'user');
    const writing = agregarMensaje('La IA est√° escribiendo...', 'ia', true);

    try {
        const res = await fetch('http://34.228.220.157:5000/preguntas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id_usuario, pregunta, id_sesion })
        });

        const datos = await res.json();
        writing.remove();

        if (res.ok && datos.respuesta) {
            agregarMensaje(datos.respuesta, 'ia');
        } else {
            agregarMensaje('‚ùå Error consultando la IA.', 'ia');
        }
    } catch (error) {
        writing.remove();
        agregarMensaje('‚ùå Error de conexi√≥n.', 'ia');
    }

    document.getElementById('pregunta').value = '';
}

// Crear burbujas de mensajes
function agregarMensaje(texto, tipo, temporal = false) {
    const contenedor = document.getElementById('chatContainer');
    const div = document.createElement('div');
    div.className = `message ${tipo}-message`;

    const icon = document.createElement('span');
    icon.className = 'message-icon';
    icon.textContent = tipo === 'user' ? 'ü•∑üèΩ' : 'ü§ñ';

    const content = document.createElement('pre');
    content.textContent = texto;

    div.appendChild(icon);
    div.appendChild(content);
    contenedor.appendChild(div);
    contenedor.scrollTop = contenedor.scrollHeight;

    return temporal ? div : null;
}

// Exportar historial (TXT)
function exportarHistorial() {
    window.open(`http://34.228.220.157:5000/exportar/${id_usuario}`, '_blank');
}

// Cerrar sesi√≥n
function cerrarSesion() {
    localStorage.clear();
    window.location.href = 'index.html';
}

// No implementados a√∫n
function abrirConfiguracion() {
    alert('Configuraci√≥n a√∫n no implementada.');
}

function editarCredenciales() {
    alert('Edici√≥n de credenciales a√∫n no implementada.');
}
</script>


</body>
</html>
